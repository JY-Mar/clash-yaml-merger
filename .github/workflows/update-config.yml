name: Update Clash Config

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©çš„ 0 ç‚¹ã€8 ç‚¹ã€16 ç‚¹ å„æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
  schedule:
    - cron: '0 0,8,16 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°é…ç½®'
        required: false
        default: false
        type: boolean

  # å½“è„šæœ¬æ–‡ä»¶æ›´æ–°æ—¶è§¦å‘
  push:
    paths:
      - 'scripts/**'
      - '.github/workflows/update-config.yml'
      - 'config/**'

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# ç¡®ä¿åªæœ‰ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡åŒæ—¶è¿è¡Œ
concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  generate-config:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up locale and encoding
        run: |
          sudo apt-get update
          sudo apt-get install -y locales language-pack-zh-hans
          sudo locale-gen zh_CN.UTF-8
          sudo update-locale LANG=zh_CN.UTF-8
          echo "LANG=zh_CN.UTF-8" >> $GITHUB_ENV
          echo "LC_ALL=zh_CN.UTF-8" >> $GITHUB_ENV
          echo "PYTHONIOENCODING=utf-8" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Create output directory
        run: |
          mkdir -p docs

      - name: 'Generate merged config'
        env:
          GITHUB_TOKEN: ${{ secrets.CLASH_GITHUB_TOKEN }}
          REPO_OWNER: ${{ secrets.CLASH_REPO_OWNER }}
          REPO_NAME: ${{ secrets.CLASH_REPO_NAME }}
          AUTH_TOKEN: ${{ secrets.CLASH_AUTH_TOKEN }}
          OUTPUT_DIR: docs
          PYTHONIOENCODING: utf-8
          PYTHONLEGACYWINDOWSFSENCODING: utf-8
          PYTHONUTF8: 1
          LC_ALL: zh_CN.UTF-8
          LANG: zh_CN.UTF-8
        run: |
          export PYTHONIOENCODING=utf-8
          export PYTHONUTF8=1
          python -c "import sys; print('Python encoding:', sys.stdout.encoding)"
          python scripts/merge_clash_config.py &
          python scripts/merge_clash_config_2.py &
          python scripts/merge_clash_config_3.py &

          wait

          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ç¼–ç 
          echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
          ls -la docs/
          CONFIG_FILE_Ash="docs/clash-Ash-${AUTH_TOKEN}.yaml"
          if [ -f "$CONFIG_FILE_Ash" ]; then
            file "$CONFIG_FILE_Ash"
            head -3 "$CONFIG_FILE_Ash"
            echo "é…ç½®æ–‡ä»¶ç”ŸæˆæˆåŠŸ: $CONFIG_FILE_Ash"
          else
            echo "é”™è¯¯: é…ç½®æ–‡ä»¶ $CONFIG_FILE_Ash æœªç”Ÿæˆ"
            exit 1

          CONFIG_FILE_CornSS="docs/clash-CornSS-${AUTH_TOKEN}.yaml"
          if [ -f "$CONFIG_FILE_CornSS" ]; then
            file "$CONFIG_FILE_CornSS"
            head -3 "$CONFIG_FILE_CornSS"
            echo "é…ç½®æ–‡ä»¶ç”ŸæˆæˆåŠŸ: $CONFIG_FILE_CornSS"
          else
            echo "é”™è¯¯: é…ç½®æ–‡ä»¶ $CONFIG_FILE_CornSS æœªç”Ÿæˆ"
            exit 1

          CONFIG_FILE_others="docs/clash-others-${AUTH_TOKEN}.yaml"
          if [ -f "$CONFIG_FILE_others" ]; then
            file "$CONFIG_FILE_others"
            head -3 "$CONFIG_FILE_others"
            echo "é…ç½®æ–‡ä»¶ç”ŸæˆæˆåŠŸ: $CONFIG_FILE_others"
          else
            echo "é”™è¯¯: é…ç½®æ–‡ä»¶ $CONFIG_FILE_others æœªç”Ÿæˆ"
            exit 1
          fi

      - name: Generate index page with authentication
        env:
          AUTH_TOKEN: ${{ secrets.CLASH_AUTH_TOKEN }}
        run: |
          # ç”Ÿæˆå¸¦æœ‰å®é™…tokençš„HTMLé¡µé¢
          cat > docs/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Clash é…ç½®æœåŠ¡</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .container {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 30px;
                  }
                  .config-info {
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 8px;
                      margin: 20px 0;
                  }
                  .url-box {
                      background: #e9ecef;
                      padding: 15px;
                      border-radius: 5px;
                      font-family: monospace;
                      word-break: break-all;
                      margin: 10px 0;
                  }
                  .warning {
                      color: #dc3545;
                      background: #f8d7da;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  .success {
                      color: #155724;
                      background: #d4edda;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  .btn {
                      display: inline-block;
                      padding: 10px 20px;
                      background: #007bff;
                      color: white;
                      text-decoration: none;
                      border-radius: 5px;
                      margin: 5px;
                  }
                  .btn:hover {
                      background: #0056b3;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸš€ Clash é…ç½®æ•´åˆæœåŠ¡</h1>
                      <p>è‡ªåŠ¨æ•´åˆå¤šä¸ªè®¢é˜…æºçš„ Clash é…ç½®æ–‡ä»¶</p>
                  </div>

                  <div class="warning">
                      <h3>âš ï¸ é‡è¦æé†’</h3>
                      <ul>
                          <li>æ­¤æœåŠ¡ä»…ä¾›ä¸ªäººä½¿ç”¨ï¼Œè¯·å‹¿åˆ†äº«é…ç½®é“¾æ¥</li>
                          <li>é…ç½®æ–‡ä»¶æ¯å¤©0 ç‚¹ã€8 ç‚¹ã€16 ç‚¹å„æ›´æ–°ä¸€æ¬¡</li>
                          <li>è®¿é—®é…ç½®éœ€è¦æ­£ç¡®çš„è®¤è¯å‚æ•°</li>
                      </ul>
                  </div>
                  
                  <div class="config-info">
                      <h3>ğŸ“Š é…ç½®ç»Ÿè®¡Ash</h3>
                      <div id="stats-Ash">åŠ è½½ä¸­...</div>
                  </div>

                  <div class="success">
                      <h3>ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h3>
                      <p>åœ¨ Clash å®¢æˆ·ç«¯ä¸­æ·»åŠ ä»¥ä¸‹è®¢é˜…é“¾æ¥ï¼š</p>
                      <div class="url-box" id="config-url">
                          https://jy-mar.github.io/clash-yaml-merger/clash-Ash-{your-token}.yaml
                      </div>
                      <p><small>è¯·å°† {your-token} æ›¿æ¢ä¸ºæ‚¨çš„å®é™…token</small></p>
                  </div>

                  <div class="config-info">
                      <h3>ğŸ“Š é…ç½®ç»Ÿè®¡CornSS</h3>
                      <div id="stats-CornSS">åŠ è½½ä¸­...</div>
                  </div>
                  
                  <div class="success">
                      <h3>ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h3>
                      <p>åœ¨ Clash å®¢æˆ·ç«¯ä¸­æ·»åŠ ä»¥ä¸‹è®¢é˜…é“¾æ¥ï¼š</p>
                      <div class="url-box" id="config-ex-url">
                          https://jy-mar.github.io/clash-yaml-merger/clash-CornSS-{your-token}.yaml
                      </div>
                      <p><small>è¯·å°† {your-token} æ›¿æ¢ä¸ºæ‚¨çš„å®é™…token</small></p>
                  </div>

                  <div class="config-info">
                      <h3>ğŸ“Š é…ç½®ç»Ÿè®¡STC/iKuuu/bestbus</h3>
                      <div id="stats-others">åŠ è½½ä¸­...</div>
                  </div>
                  
                  <div class="success">
                      <h3>ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h3>
                      <p>åœ¨ Clash å®¢æˆ·ç«¯ä¸­æ·»åŠ ä»¥ä¸‹è®¢é˜…é“¾æ¥ï¼š</p>
                      <div class="url-box" id="config-ex-url">
                          https://jy-mar.github.io/clash-yaml-merger/clash-others-{your-token}.yaml
                      </div>
                      <p><small>è¯·å°† {your-token} æ›¿æ¢ä¸ºæ‚¨çš„å®é™…token</small></p>
                  </div>
              </div>
              
              <script>
                  // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
                  function fetchStats(version_file_suffix) {
                    fetch('stats' + version_file_suffix + '.json')
                      .then(response => response.json())
                      .then(data => {
                          const statsDiv = document.getElementById('stats' + version_file_suffix);
                          let dateStr = ''
                          const generateDate = new Date(data.generated_at)
                          if (typeof generateDate === 'object' && generateDate instanceof Date) {
                              const yyyy = generateDate.getFullYear()
                              let MM = generateDate.getMonth() + 1
                              MM = MM < 10 ? '0' + MM : MM
                              let dd = generateDate.getDate()
                              dd = dd < 10 ? '0' + dd : dd
                              let HH = generateDate.getHours()
                              HH = HH < 10 ? '0' + HH : HH
                              let mm = generateDate.getMinutes()
                              mm = mm < 10 ? '0' + mm : mm
                              let ss = generateDate.getSeconds()
                              ss = ss < 10 ? '0' + ss : ss
                              dateStr = `${yyyy}-${MM}-${dd} ${HH}:${mm}:${ss}`
                          } else {
                              dateStr = String(data.generated_at)
                          }
                          statsDiv.innerHTML = `
                              <p><strong>ä»£ç†é›†æ•°é‡ï¼š</strong> ${data.proxy_providers_count}</p>
                              <p><strong>ä»£ç†èŠ‚ç‚¹æ•°é‡ï¼š</strong> ${data.proxies_count}</p>
                              <p><strong>ä»£ç†ç»„æ•°é‡ï¼š</strong> ${data.proxy_groups_count}</p>
                              <p><strong>è§„åˆ™æ•°é‡ï¼š</strong> ${data.rules_count}</p>
                              <p><strong>æœ€åæ›´æ–°ï¼š</strong> ${dateStr}</p>
                          `;
                      })
                      .catch(error => {
                          document.getElementById('stats' + version_file_suffix).innerHTML = '<p style="color: red;">åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥</p>';
                      });
                  }
                  fetchStats('-Ash')
                  fetchStats('-CornSS')
                  fetchStats('-others')
              </script>
          </body>
          </html>
          HTMLEOF

      - name: Create authentication wrapper
        env:
          AUTH_TOKEN: ${{ secrets.CLASH_AUTH_TOKEN }}
        run: |
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„è®¤è¯åŒ…è£…å™¨
          cat > docs/clash.yaml.php << 'EOF'
          <?php
          // ç®€å•çš„è®¤è¯æ£€æŸ¥
          $required_token = getenv('AUTH_TOKEN') ?: 'your-auth-token';
          $provided_token = $_GET['token'] ?? '';

          if ($provided_token !== $required_token) {
              http_response_code(404);
              echo "Not Found";
              exit;
          }

          // è¿”å›é…ç½®æ–‡ä»¶
          header('Content-Type: application/x-yaml');
          header('Content-Disposition: attachment; filename="clash.yaml"');
          readfile('clash.yaml');
          ?>
          EOF

          # ç”±äºGitHub Pagesä¸æ”¯æŒPHPï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªJavaScriptç‰ˆæœ¬
          cat > docs/get-config.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Clash Config</title>
          </head>
          <body>
              <script>
                  const urlParams = new URLSearchParams(window.location.search);
                  const token = urlParams.get('token');
                  
                  if (token) {
                      // è¿™é‡Œåº”è¯¥æ˜¯æ‚¨çš„è®¤è¯token
                      const validToken = '${AUTH_TOKEN}';
                      if (token === validToken) {
                          // é‡å®šå‘åˆ°å®é™…çš„é…ç½®æ–‡ä»¶
                          window.location.href = 'clash-${AUTH_TOKEN}.yaml';
                      } else {
                          // è¿”å›404
                          document.body.innerHTML = '<h1>404 Not Found</h1>';
                          document.title = '404 Not Found';
                      }
                  } else {
                      // è¿”å›404
                      document.body.innerHTML = '<h1>404 Not Found</h1>';
                      document.title = '404 Not Found';
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: generate-config

    steps:
      - name: ğŸ§¹ Clean up old Deployment Records
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.CLASH_GITHUB_TOKEN }}
          environment: github-pages
          onlyRemoveDeployments: true

      - name: â¬†ï¸ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
