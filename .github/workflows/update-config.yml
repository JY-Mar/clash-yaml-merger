name: Update Clash Config

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©çš„ 8 ç‚¹ï¼ˆUTC+8ï¼‰ å„æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
  schedule:
    - cron: "0 8 * * *"

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: "å¼ºåˆ¶æ›´æ–°é…ç½®"
        required: false
        default: false
        type: boolean

  # å½“è„šæœ¬æ–‡ä»¶æ›´æ–°æ—¶è§¦å‘
  push:
    paths:
      - "scripts/**"
      - ".github/workflows/update-config.yml"
      - "config/**"

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# ç¡®ä¿åªæœ‰ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡åŒæ—¶è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-config:
    runs-on: ubuntu-latest
    environment: github-pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Set up locale and encoding
        run: |
          sudo apt-get update
          sudo apt-get install -y locales language-pack-zh-hans
          sudo locale-gen zh_CN.UTF-8
          sudo update-locale LANG=zh_CN.UTF-8
          echo "LANG=zh_CN.UTF-8" >> $GITHUB_ENV
          echo "LC_ALL=zh_CN.UTF-8" >> $GITHUB_ENV
          echo "PYTHONIOENCODING=utf-8" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Create output directory
        run: |
          mkdir -p docs

      - name: "Generate merged config"
        env:
          GITHUB_TOKEN: ${{ secrets.CLASH_GITHUB_TOKEN }}
          REPO_OWNER: ${{ secrets.CLASH_REPO_OWNER }}
          REPO_NAME: ${{ secrets.CLASH_REPO_NAME }}
          AUTH_TOKEN: ${{ secrets.CLASH_AUTH_TOKEN }}
          REMOTE_YAMLS: ${{ vars.CLASH_ENV_REMOTE_YAMLS }}
          FCONFS_DIRECTORIES: ${{ vars.CLASH_ENV_FCONFS_DIRECTORIES }}
          OUTPUT_DIR: docs
          PYTHONIOENCODING: utf-8
          PYTHONLEGACYWINDOWSFSENCODING: utf-8
          PYTHONUTF8: 1
          LC_ALL: zh_CN.UTF-8
          LANG: zh_CN.UTF-8
        run: |
          export PYTHONIOENCODING=utf-8
          export PYTHONUTF8=1
          python -c "import sys; print('Python encoding:', sys.stdout.encoding)"

          PY_FILE="scripts/merge_clash_config.py"

          python "$PY_FILE"

          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ç¼–ç 
          echo "=== â†“â†“â†“ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ â†“â†“â†“ ==="

          # å…ˆæŒ‰ ; åˆ†å‰²
          IFS=';' read -ra groups <<< "$FCONFS_DIRECTORIES"
          NEW_PARAMS=()
          for group in "${groups[@]}"; do
            # æ¯ä¸ª group å†æŒ‰ | åˆ†å‰²
            IFS='|' read -ra parts <<< "$group"
            # å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå³ | å‰çš„éƒ¨åˆ†ï¼‰
            NEW_PARAMS+=("${parts[0]}")
          done

          len=${#NEW_PARAMS[@]}
          ls -la docs/
          for ((i=0; i<len; i++)); do
            temp=${NEW_PARAMS[$i]}
            CONFIG_FILE="docs/clash-${temp}-${AUTH_TOKEN}.yaml"
            if [ -f "$CONFIG_FILE" ]; then
              file "$CONFIG_FILE"
              head -3 "$CONFIG_FILE"
              echo "é…ç½®æ–‡ä»¶ç”ŸæˆæˆåŠŸ: $CONFIG_FILE"
            else
              echo "é”™è¯¯: é…ç½®æ–‡ä»¶ $CONFIG_FILE æœªç”Ÿæˆ"
              exit 1
            fi
            echo "=== æ£€æŸ¥è¿›åº¦ $((i+1)) / $len ==="
          done
          echo "=== â†‘â†‘â†‘ æ–‡ä»¶ç”Ÿæˆæ£€æŸ¥å®Œæ¯• â†‘â†‘â†‘ ==="

      - name: Generate index page with authentication
        env:
          AUTH_TOKEN: ${{ secrets.CLASH_AUTH_TOKEN }}
        run: |
          # ç”Ÿæˆå¸¦æœ‰å®é™…tokençš„HTMLé¡µé¢
          cat > docs/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Clash é…ç½®æœåŠ¡</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .container {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 30px;
                  }
                  .config-info {
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 8px;
                      margin: 20px 0;
                  }
                  .config-info + .success {
                      margin-top: 0px !important;
                      border-top-left-radius: 0px !important;
                      border-top-right-radius: 0px !important;
                  }
                  :has(.config-info + .success) .config-info {
                      margin-bottom: 0px !important;
                      border-bottom-left-radius: 0px !important;
                      border-bottom-right-radius: 0px !important;
                  }
                  .url-box {
                      background: #e9ecef;
                      padding: 15px;
                      border-radius: 5px;
                      font-family: monospace;
                      word-break: break-all;
                      margin: 10px 0;
                  }
                  .warning {
                      color: #dc3545;
                      background: #f8d7da;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  .success {
                      color: #155724;
                      background: #d4edda;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  .btn {
                      display: inline-block;
                      padding: 10px 20px;
                      background: #007bff;
                      color: white;
                      text-decoration: none;
                      border-radius: 5px;
                      margin: 5px;
                  }
                  .btn:hover {
                      background: #0056b3;
                  }
                  .block-class {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  }
                  .label-class,
                  .sub-label-class {
                    white-space: nowrap;
                  }
                  .sub-label-class {
                    margin-left: 65px;
                    font-weight: 400;
                  }
                  .sub-label-class::before {
                    content: "â”œâ”€â”€";
                    margin-right: 5px;
                  }
                  .block-class:has(.label-class > .sub-label-class) + .block-class:has(.label-class > .sub-label-class) > .label-class > .sub-label-class::before {
                    content: "â””â”€â”€";
                  }
                  .content-class {}
                  .dots-class {
                    flex-grow: 1;
                    overflow: hidden;
                    white-space: nowrap;
                    text-align: center;
                    font-size: 16px;
                    line-height: 1;
                    margin-left: 10px;
                    margin-right: 10px;
                  }
                  .dots-class::before {
                    content: '';
                    display: inline-block;
                    width: 100%;
                    background-image: repeating-linear-gradient(to right, transparent 0, transparent 2px, currentColor 2px, currentColor 4px);
                    height: 1px;
                    vertical-align: middle;
                  }
              </style>
          </head>
          <body>
              <script>
                window.ENV = {
                  FCONFS_DIRECTORIES: "${{ vars.CLASH_ENV_FCONFS_DIRECTORIES }}"
                };
              </script>

              <div class="container">
                  <div class="header">
                      <h1>ğŸš€ Clash é…ç½®æ•´åˆæœåŠ¡</h1>
                      <p>è‡ªåŠ¨æ•´åˆå¤šä¸ªè®¢é˜…æºçš„ Clash é…ç½®æ–‡ä»¶</p>
                  </div>

                  <div class="warning">
                      <h3>âš ï¸ é‡è¦æé†’</h3>
                      <ul>
                          <li>æ­¤æœåŠ¡ä»…ä¾›ä¸ªäººä½¿ç”¨ï¼Œè¯·å‹¿åˆ†äº«é…ç½®é“¾æ¥</li>
                          <li>é…ç½®æ–‡ä»¶æ¯å¤© 8 ç‚¹ï¼ˆUTC+8ï¼‰æ›´æ–°ä¸€æ¬¡</li>
                          <li>è®¿é—®é…ç½®éœ€è¦æ­£ç¡®çš„è®¤è¯å‚æ•°</li>
                      </ul>
                  </div>
              </div>
              
              <script>
                  const container = document.querySelector('.container');
                  let updateTime_DOM = document.querySelector('.config-info.updateTime');
                  if (!updateTime_DOM) {
                    updateTime_DOM = document.createElement('div');
                    updateTime_DOM.className = 'config-info updateTime';
                  }
                  if (container && updateTime_DOM) {
                      container.appendChild(updateTime_DOM);
                  }
                  const class_names = (window.ENV.FCONFS_DIRECTORIES || '').split(';').map((v) => (v || '').split('|')?.[0]).filter((v) => v !== undefined && v !== null && v !== '').map((v) => ({ label: v }));
                  class_names.forEach((class_name) => {
                      const dom = document.querySelector('.config-info.' + class_name.label);
                      if (dom) {
                          return;
                      }
                      // åˆ›å»ºé…ç½®ç»Ÿè®¡åŒºåŸŸ
                      const configInfo = document.createElement('div');
                      configInfo.className = "config-info " + class_name.label;

                      const title_main = document.createElement("h1");
                      title_main.textContent = "ğŸš€ é…ç½®æ–‡ä»¶ " + class_name.label + (class_name.remark ? "(" + class_name.remark + ")" : "");

                      configInfo.appendChild(title_main);

                      const title_for_subs = document.createElement("h3");
                      title_for_subs.textContent = "ğŸ“Œ è®¢é˜…è¯¦æƒ…";

                      const subs = document.createElement("div");
                      subs.id = "subs" + "-" + class_name.label;
                      subs.textContent = "åŠ è½½ä¸­...";

                      configInfo.appendChild(title_for_subs);
                      configInfo.appendChild(subs);

                      const title_for_stats = document.createElement("h3");
                      title_for_stats.textContent = "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯";

                      const stats = document.createElement("div");
                      stats.id = "stats" + "-" + class_name.label;
                      stats.textContent = "åŠ è½½ä¸­...";

                      configInfo.appendChild(title_for_stats);
                      configInfo.appendChild(stats);

                      // åˆ›å»ºä½¿ç”¨æ–¹æ³•åŒºåŸŸ
                      const successBox = document.createElement("div");
                      successBox.className = "success";

                      const title_for_usage = document.createElement("h3");
                      title_for_usage.textContent = "ğŸ“‹ ä½¿ç”¨æ–¹æ³•";

                      const desc = document.createElement("p");
                      desc.textContent = "åœ¨ Clash å®¢æˆ·ç«¯ä¸­æ·»åŠ ä»¥ä¸‹è®¢é˜…é“¾æ¥ï¼š";

                      const urlBox = document.createElement("div");
                      urlBox.className = "url-box";
                      urlBox.id = "config-url";
                      urlBox.textContent = "https://jy-mar.github.io/clash-yaml-merger/clash-" + class_name.label + "-{your-token}.yaml";

                      const tip = document.createElement("p");
                      const small = document.createElement("small");
                      small.textContent = "è¯·å°† {your-token} æ›¿æ¢ä¸ºæ‚¨çš„å®é™…token";
                      tip.appendChild(small);

                      // æ·»åŠ æ‰€æœ‰å…ƒç´ åˆ° successBox
                      successBox.appendChild(title_for_usage);
                      successBox.appendChild(desc);
                      successBox.appendChild(urlBox);
                      successBox.appendChild(tip);

                      // æ·»åŠ åˆ°é¡µé¢
                      if (container) {
                          container.appendChild(configInfo);
                          container.appendChild(successBox);
                      }
                  });
                  function generateDesctiptionItem(label, value) {
                    let _label = label
                    if (typeof label === 'string' && label) {
                      if ((label.startsWith('<strong') && label.endsWith('</strong>')) || label.endsWith('ï¼š')) {
                        _label = label
                      } else {
                        _label = `${label}ï¼š`
                      }
                    }
                    return `
                      <p class="block-class">
                        <strong class="label-class">
                          ${_label}
                        </strong>
                        <span class="dots-class"></span>
                        <span class="content-class">${value}</span>
                      </p>
                    `;
                  }
                  function generateSubDesctiptionItem(label, value) {
                    return generateDesctiptionItem(`<strong class="sub-label-class">${label}ï¼š</strong>`, value);
                  }
                  // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
                  function fetchStats(filename) {
                    fetch('stats' + filename + '.json')
                      .then(response => response.json())
                      .then(data => {
                          const subs_DOM = document.getElementById('subs' + filename);
                          const stats_DOM = document.getElementById('stats' + filename);
                          let dateStr = ''
                          const generateDate = new Date(data.generated_at)
                          if (typeof generateDate === 'object' && generateDate instanceof Date) {
                              const yyyy = generateDate.getFullYear()
                              let MM = generateDate.getMonth() + 1
                              MM = MM < 10 ? '0' + MM : MM
                              let dd = generateDate.getDate()
                              dd = dd < 10 ? '0' + dd : dd
                              let HH = generateDate.getHours()
                              HH = HH < 10 ? '0' + HH : HH
                              let mm = generateDate.getMinutes()
                              mm = mm < 10 ? '0' + mm : mm
                              let ss = generateDate.getSeconds()
                              ss = ss < 10 ? '0' + ss : ss
                              dateStr = `${yyyy}-${MM}-${dd} ${HH}:${mm}:${ss}`
                          } else {
                              dateStr = String(data.generated_at)
                          }
                          const _proxy_providers__proxies__count = data.proxy_providers__proxies__count || {}
                          
                          subs_DOM.innerHTML = `
                              ${Object.entries(_proxy_providers__proxies__count).map(([k, v]) => generateDesctiptionItem(k, v.useinfo || '')).join('')}
                          `;

                          stats_DOM.innerHTML = `
                              ${generateDesctiptionItem('ä»£ç†é›†æ•°é‡', data.proxy_providers_count)}
                              ${generateDesctiptionItem('ä»£ç†èŠ‚ç‚¹æ€»æ•°', data.total_proxies_count)}
                              ${generateSubDesctiptionItem('ç‹¬ç«‹èŠ‚ç‚¹', data.indep_proxies_count)}
                              ${Object.entries(_proxy_providers__proxies__count).map(([k, v]) => generateSubDesctiptionItem('ä»£ç†é›†[' + k + ']', v.count || 0)).join('')}
                              ${generateDesctiptionItem('ç­–ç•¥ç»„æ•°é‡', data.proxy_groups_count)}
                              ${generateDesctiptionItem('è§„åˆ™é›†æ•°é‡', data.rule_providers_count)}
                              ${generateDesctiptionItem('è§„åˆ™æ€»æ•°', data.total_rules_count)}
                              ${generateSubDesctiptionItem('ç‹¬ç«‹è§„åˆ™', data.indep_rules_count)}
                              ${generateSubDesctiptionItem('è§„åˆ™é›†', data.rules__rule_set__count)}
                          `;
                          if (updateTime_DOM) {
                              updateTime_DOM.innerHTML = `
                                  <p class="block-class">
                                    <strong class="label-class">
                                      æœ€åæ›´æ–°ï¼š
                                    </strong>
                                    <span class="dots-class"></span>
                                    <span class="content-class">${dateStr}</span>
                                  </p>
                              `;
                          }
                      })
                      .catch((error) => {
                          console.error('Error:', error);
                          document.getElementById('subs' + filename).innerHTML = '<p style="color: red;">åŠ è½½è®¢é˜…ä¿¡æ¯å¤±è´¥</p>';
                          document.getElementById('stats' + filename).innerHTML = '<p style="color: red;">åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥</p>';
                      });
                  }
                  const intervals = Object.fromEntries(class_names.map((class_name) => [class_name.label, null]));
                  
                  window.onload = function () {
                      class_names.forEach((class_name) => {
                          if (intervals[class_name.label] !== undefined && intervals[class_name.label] !== null) {
                              clearInterval(intervals[class_name.label]);
                              intervals[class_name.label] = undefined;
                          };
                          intervals[class_name.label] = setInterval(() => {
                              const subs_DOM = document.getElementById('subs' + '-' + class_name.label)
                              const stats_DOM = document.getElementById('stats' + '-' + class_name.label)
                              if (subs_DOM && stats_DOM) {
                                  fetchStats('-' + class_name.label)
                                  clearInterval(intervals[class_name.label]);
                                  intervals[class_name.label] = null;
                              }
                          }, 70);
                      })
                  };
              </script>
          </body>
          </html>
          HTMLEOF

      - name: Create authentication wrapper
        env:
          AUTH_TOKEN: ${{ secrets.CLASH_AUTH_TOKEN }}
        run: |
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„è®¤è¯åŒ…è£…å™¨
          cat > docs/clash.yaml.php << 'EOF'
          <?php
          // ç®€å•çš„è®¤è¯æ£€æŸ¥
          $required_token = getenv('AUTH_TOKEN') ?: 'your-auth-token';
          $provided_token = $_GET['token'] ?? '';

          if ($provided_token !== $required_token) {
              http_response_code(404);
              echo "Not Found";
              exit;
          }

          // è¿”å›é…ç½®æ–‡ä»¶
          header('Content-Type: application/x-yaml');
          header('Content-Disposition: attachment; filename="clash.yaml"');
          readfile('clash.yaml');
          ?>
          EOF

          # ç”±äºGitHub Pagesä¸æ”¯æŒPHPï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªJavaScriptç‰ˆæœ¬
          cat > docs/get-config.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Clash Config</title>
          </head>
          <body>
              <script>
                  const urlParams = new URLSearchParams(window.location.search);
                  const token = urlParams.get('token');
                  
                  if (token) {
                      // è¿™é‡Œåº”è¯¥æ˜¯æ‚¨çš„è®¤è¯token
                      const validToken = '${AUTH_TOKEN}';
                      if (token === validToken) {
                          // é‡å®šå‘åˆ°å®é™…çš„é…ç½®æ–‡ä»¶
                          window.location.href = 'clash-${AUTH_TOKEN}.yaml';
                      } else {
                          // è¿”å›404
                          document.body.innerHTML = '<h1>404 Not Found</h1>';
                          document.title = '404 Not Found';
                      }
                  } else {
                      // è¿”å›404
                      document.body.innerHTML = '<h1>404 Not Found</h1>';
                      document.title = '404 Not Found';
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: generate-config

    steps:
      - name: ğŸ§¹ Clean up old Deployment Records
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.CLASH_GITHUB_TOKEN }}
          environment: github-pages
          onlyRemoveDeployments: true

      - name: â¬†ï¸ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
